# Implementation Plan: Test Suite Refactoring

**Branch**: `022-test-suite-refactoring` | **Date**: 2025-11-02 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/022-test-suite-refactoring/spec.md`

## Summary

Refactor Eligian test suite to eliminate ~550 lines of duplicated code by creating shared test utilities, standardizing lifecycle hooks, and converting loop-based tests to Vitest's `test.each()`. This work reduces maintenance burden, improves test consistency, and makes test writing 40% faster for developers. Based on comprehensive analysis in [TEST_SUITE_ANALYSIS.md](../../TEST_SUITE_ANALYSIS.md).

**Primary Requirements**:
- Create shared test helper module (`test-helpers.ts`) with common setup utilities
- Eliminate 400+ lines of service initialization duplication across 40+ test files
- Eliminate 150+ lines of CSS registry setup duplication across 24+ test files
- Standardize lifecycle hook patterns (beforeAll/beforeEach/afterEach)
- Convert loop-based tests to parameterized tests using `test.each()`

**Technical Approach**: Incremental refactoring in 3 phases (P1 high priority, P2 medium, P3 low) with validation after each phase ensures zero test regressions while maintaining 81.72%+ coverage.

## Technical Context

**Language/Version**: TypeScript 5.x with Node.js ESM (NodeNext module resolution)
**Primary Dependencies**: Vitest 3.2.4 (test framework), Langium 3.0+ (language testing utilities)
**Storage**: N/A (test infrastructure only)
**Testing**: Vitest with parseHelper, EmptyFileSystem, DocumentBuilder
**Target Platform**: Node.js 19+ (development environment)
**Project Type**: Single project (monorepo package) - test infrastructure refactoring
**Performance Goals**: Test suite runtime ≤10 seconds (currently ~8s), helper overhead <1ms per call
**Constraints**: Zero test regressions (all 1462 tests must continue passing), maintain 81.72%+ coverage
**Scale/Scope**: 85 test files, 1462 tests, 40+ files with service setup duplication, 24+ files with CSS setup duplication

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with `.specify/memory/constitution.md`:

- [x] **Simplicity & Documentation**: Approach is clear - extract duplicated code into shared utilities. Well-documented in TEST_SUITE_ANALYSIS.md with before/after examples.
- [x] **Comprehensive Testing**: Existing tests verify behavior. Refactoring preserves all test logic. No new business logic added (only test infrastructure), so new tests not applicable.
- [x] **No Gold-Plating**: Solves real, documented need - 550 lines of duplication identified in analysis. Focused on P1 (high priority) improvements only.
- [x] **Code Review**: Standard PR process applies. All changes reviewable via git diff showing identical test behavior.
- [x] **UX Consistency**: Test helpers follow existing Langium patterns (parseHelper, createEligianServices). Consistent API across all test files.
- [x] **Functional Programming**: Test helpers are pure functions returning immutable contexts. Each test gets independent service instance (no shared mutable state).

*No violations. All principles satisfied.*

## Project Structure

### Documentation (this feature)

```
specs/022-test-suite-refactoring/
├── plan.md              # This file
├── research.md          # Phase 0: Not needed (analysis complete in TEST_SUITE_ANALYSIS.md)
├── data-model.md        # Phase 1: Not applicable (test infrastructure, not data-driven)
├── quickstart.md        # Phase 1: Quick reference for using test helpers
├── contracts/           # Phase 1: Not applicable (internal test utilities, no public API)
└── tasks.md             # Phase 2: Generated by /speckit.tasks command
```

### Source Code (repository root)

```
packages/language/src/__tests__/
├── test-helpers.ts              # NEW: Shared test utilities (Phase 1)
│   ├── createTestContext()      # Service + parse + parseAndValidate helper
│   ├── setupCSSRegistry()       # CSS registry population helper
│   ├── CSS_FIXTURES             # Predefined CSS test data
│   ├── DiagnosticSeverity enum  # Severity level constants
│   ├── getErrors()              # Error filtering helper
│   └── getWarnings()            # Warning filtering helper
│
├── parsing.spec.ts              # REFACTOR: Use test-helpers.ts (Phase 1)
├── validation.spec.ts           # REFACTOR: Use test-helpers.ts (Phase 1)
├── typir-*.spec.ts              # REFACTOR: Use test-helpers.ts (Phase 1)
│
├── css-classname-validation/    # REFACTOR: Use CSS_FIXTURES (Phase 1)
│   ├── valid-classname.spec.ts
│   └── unknown-classname.spec.ts
│
├── css-selector-validation/     # REFACTOR: Use CSS_FIXTURES (Phase 1)
│   ├── valid-selector.spec.ts
│   ├── unknown-selector.spec.ts
│   └── invalid-syntax.spec.ts
│
└── [35+ other test files]       # REFACTOR: Incremental migration (Phase 2+)
```

**Structure Decision**: This feature adds a single shared test utilities module (`test-helpers.ts`) to the existing `__tests__/` directory. No new packages or directories created. All refactoring happens within `packages/language/src/__tests__/`.

## Complexity Tracking

*No constitution violations to justify - all checks passed.*

## Phase 0: Research (SKIPPED)

**Status**: Not needed - comprehensive analysis already complete in `TEST_SUITE_ANALYSIS.md`.

**Rationale**: The TEST_SUITE_ANALYSIS.md document (generated 2025-11-02) provides:
- Complete duplication analysis with grep counts and line estimates
- Langium test helper usage patterns verified against official documentation
- Vitest 3.2.4 best practices verified via Context7 MCP server
- Before/after code examples showing refactoring approach
- 3-phase action plan with time/ROI estimates

All research questions answered. No NEEDS CLARIFICATION markers exist.

## Phase 1: Design & Contracts

**Prerequisites**: None (skipping Phase 0)

### Design Artifacts

This phase generates the following artifacts:

1. **quickstart.md**: Quick reference guide for using test helpers
   - How to import and use `createTestContext()`
   - How to use `setupCSSRegistry()` with fixtures
   - How to migrate existing test files
   - Before/after code examples

2. **data-model.md**: NOT APPLICABLE
   - Rationale: This feature refactors test infrastructure (pure utilities), not data models

3. **contracts/**: NOT APPLICABLE
   - Rationale: Test helpers are internal utilities, not public API contracts

### Test Helper API Design

**Core Interfaces** (to be implemented in `test-helpers.ts`):

```typescript
// TestContext: Container for test infrastructure
export interface TestContext {
  services: ReturnType<typeof createEligianServices>;
  parse: ReturnType<typeof parseHelper<Program>>;
  parseAndValidate: (code: string, cssFileUri?: string) => Promise<ValidationResult>;
}

// ValidationResult: Structured validation output
export interface ValidationResult {
  document: LangiumDocument<Program>;
  program: Program;
  diagnostics: Diagnostic[];
  errors: Diagnostic[];      // Filtered: severity === 1
  warnings: Diagnostic[];    // Filtered: severity === 2
}

// CSSFixture: CSS test data definition
export interface CSSFixture {
  classes?: string[];
  ids?: string[];
}

// DiagnosticSeverity: Langium LSP protocol severity levels
export enum DiagnosticSeverity {
  Error = 1,
  Warning = 2,
  Information = 3,
  Hint = 4,
}
```

**Factory Functions**:

```typescript
// Create test context with services, parse, and parseAndValidate
export function createTestContext(): TestContext

// Setup CSS registry with fixtures
export function setupCSSRegistry(
  ctx: TestContext,
  cssFileUri: string = 'file:///styles.css',
  fixture: CSSFixture = CSS_FIXTURES.common
): void

// Filter diagnostics by severity
export function getErrors(document: LangiumDocument): Diagnostic[]
export function getWarnings(document: LangiumDocument): Diagnostic[]
```

**Predefined Fixtures**:

```typescript
export const CSS_FIXTURES = {
  common: {
    classes: ['button', 'primary', 'secondary', 'active', 'hidden', 'visible'],
    ids: ['app', 'container', 'box', 'element'],
  },
  timeline: {
    classes: ['test-container', 'container', 'presentation-container'],
    ids: ['test', 'title', 'credits'],
  },
};
```

### Migration Strategy

**Phase 1 (P1 - High Priority)**:
- Create `test-helpers.ts` with all utilities
- Refactor 10 high-traffic test files (validation.spec.ts, parsing.spec.ts, typir-*.spec.ts)
- Estimated: 8 hours, saves ~400 lines

**Phase 2 (P2 - Medium Priority)**:
- Standardize lifecycle hooks across 20+ test files
- Convert 5-10 loop-based tests to test.each()
- Estimated: 7 hours, saves ~150 lines

**Phase 3 (P3 - Low Priority)**:
- Custom matchers (toHaveErrorMatching, toHaveWarningMatching)
- Performance profiling
- Documentation (TESTING.md)
- Estimated: 3 hours, saves ~50 lines

**Total ROI**: 18 hours investment, 550 lines saved, ~7 hours/month maintenance reduction

## Constitution Re-Check (Post-Design)

Re-verify compliance after design phase:

- [x] **Simplicity & Documentation**: Design is simple - pure utility functions with clear interfaces. TypeScript types provide self-documentation.
- [x] **Comprehensive Testing**: Existing tests verify behavior. Refactoring verified by running full suite after each file migration.
- [x] **No Gold-Plating**: Design covers only P1 requirements (shared utilities, CSS fixtures). P2/P3 deferred.
- [x] **Code Review**: PR will show clear before/after diffs. Test output remains identical.
- [x] **UX Consistency**: Helper API follows Langium patterns. Consistent with existing createEligianServices() usage.
- [x] **Functional Programming**: All helpers are pure functions. createTestContext() returns fresh instance per test.

*All checks pass. Ready for task generation.*

## Success Criteria Mapping

| Success Criterion | How Achieved | Verification Method |
|------------------|--------------|---------------------|
| SC-001: ≥400 lines reduced | Extract service init to test-helpers.ts | `git diff --stat` after Phase 1 |
| SC-002: 40+ → 1 shared impl | createTestContext() replaces all instances | `grep -r "createEligianServices" __tests__` count |
| SC-003: 24+ → predefined fixtures | CSS_FIXTURES replaces all CSS setups | `grep -r "cssRegistry.updateCSSFile" __tests__` count |
| SC-004: 40% faster test writing | Measure time to write 3 new tests | Before/after timing comparison |
| SC-005: test.each() shows scenarios | Convert loop tests in Phase 2 | Vitest output shows individual scenario names |
| SC-006: Zero regressions | Run full suite after each migration | `pnpm test` (all 1462 tests pass) |
| SC-007: ≥81.72% coverage | No coverage regression | `pnpm run test:coverage` |
| SC-008: ≤10s runtime | Helper overhead <1ms | `pnpm test` execution time |
| SC-009: 30% satisfaction improvement | Developer survey after 2 weeks | Team feedback |
| SC-010: 50% maintenance reduction | Measure update time for common changes | Before/after timing comparison |

## Next Steps

1. Generate quickstart.md (Phase 1 artifact)
2. Run `/speckit.tasks` to generate detailed task breakdown
3. Begin Phase 1 implementation:
   - Create test-helpers.ts
   - Refactor 10 high-traffic test files
   - Verify all tests pass and coverage maintained
4. Phase 2 and Phase 3 will be executed based on tasks.md

---

**Plan Status**: ✅ COMPLETE - Ready for quickstart generation

**Date Completed**: 2025-11-02
