# Tasks: Custom Action Reference Provider

**Input**: Design documents from `/specs/007-custom-action-reference/`
**Prerequisites**: plan.md, spec.md, research.md, data-model.md, contracts/

**Tests**: Test-First Development (TDD) is REQUIRED per Constitution Principle II. All tests must be written BEFORE implementation.

**Organization**: Tasks are grouped by user story to enable independent implementation and testing of each story.

**UPDATED**: 2025-10-24 - Switched to indexed approach (ScopeComputation) for library import support

## Format: `[ID] [P?] [Story] Description`
- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (e.g., US1, US2, US3)
- Include exact file paths in descriptions

## Path Conventions
- Single project structure: `packages/language/src/`, `packages/language/src/__tests__/`
- All paths relative to repository root: `f:/projects/eligius/eligian/`

---

## Phase 1: Setup (Shared Infrastructure)

**Purpose**: Project initialization and verify existing structure

- [ ] T001 [P] Verify Langium services registration in `packages/language/src/eligian-module.ts`
- [ ] T002 [P] Verify existing `EligianScopeProvider` in `packages/language/src/eligian-scope-provider.ts`
- [ ] T003 [P] Check existing test infrastructure (Vitest, `@langium/testing`, `parseHelper`)

**Checkpoint**: Existing infrastructure verified - no setup changes needed

---

## Phase 2: Foundational (Blocking Prerequisites)

**Purpose**: Core indexing infrastructure needed by ALL user stories

**‚ö†Ô∏è CRITICAL**: No user story work can begin until this phase is complete

### Tests for Foundational (Test-First Development - RED phase)

- [ ] T004 [P] [Foundation] Write unit tests for ScopeComputation in `packages/language/src/__tests__/scope-computation.spec.ts`
  - Test `computeLocalScopes()` indexes all actions in document
  - Test precomputed scopes contain correct AstNodeDescriptions
  - Test action descriptions have correct names and types
  - Test empty document (no actions) returns empty scopes
  - Test document with 10+ actions indexes all correctly
  - **Verify tests FAIL (RED phase)**

- [ ] T005 [P] [Foundation] Add type guard `isOperationCall()` in `packages/language/src/utils/ast-utils.ts` (if not exists)
  - Check if it's already generated by Langium in `generated/ast.ts`
  - If not generated, create helper function
  - Write unit test for type guard (if custom implementation)

### Implementation for Foundational (GREEN phase)

- [ ] T006 [Foundation] Create `EligianScopeComputation` class in `packages/language/src/eligian-scope-computation.ts`
  - Import required Langium types: `DefaultScopeComputation`, `LangiumDocument`, `PrecomputedScopes`, `MultiMap`, `AstNodeDescription`
  - Import AST types: `EligianModel`, `ActionDefinition`
  - Extend `DefaultScopeComputation`
  - Override `async computeLocalScopes(document: LangiumDocument): Promise<PrecomputedScopes>`
  - Get model from `document.parseResult.value as EligianModel`
  - Create `MultiMap<AstNode, AstNodeDescription>` for scopes
  - Loop through `model.actions`, create description for each
  - Use `this.descriptions.createDescription(action, action.name, document)`
  - Add descriptions to scopes at model level: `scopes.add(model, description)`
  - Return scopes
  - Add JSDoc explaining O(1) lookup benefits, library import future support

- [ ] T007 [Foundation] Register `EligianScopeComputation` in `packages/language/src/eligian-module.ts`
  - Import `EligianScopeComputation` from `./eligian-scope-computation.js`
  - Add to `references` section: `ScopeComputation: (services) => new EligianScopeComputation(services)`
  - Verify existing `ScopeProvider` registration is present

- [ ] T008 [Foundation] Verify ScopeComputation unit tests pass (GREEN phase)
  - Run `npm run test -- scope-computation.spec.ts`
  - All foundational tests should now pass
  - If not, debug and fix implementation

**Checkpoint**: Foundation ready - user story implementation can now begin in parallel

---

## Phase 3: User Story 1 - Navigate to Action Definition from Direct Timeline Calls (Priority: P1) üéØ MVP

**Goal**: Enable Ctrl+Click navigation from direct timeline action calls (e.g., `at 0s..1s fadeIn()`) to action definitions

**Independent Test**: Create `.eligian` file with one action definition and one direct timeline call, verify Ctrl+Click navigates to definition

### Tests for User Story 1 (Test-First Development - RED phase)

**NOTE: Write these tests FIRST, ensure they FAIL before implementation**

- [ ] T009 [P] [US1] Write ScopeProvider unit test for direct timeline call in `packages/language/src/__tests__/references.spec.ts`
  - Test `getScope()` returns Scope with ActionDefinition for OperationCall
  - Test `getScope()` returns EMPTY_SCOPE for non-existent action
  - Test `getScope()` delegates to super for non-OperationCall containers
  - Test `getScope()` uses precomputed scopes (verify O(1) lookup)
  - **Verify tests FAIL (RED phase)**

- [ ] T010 [P] [US1] Write integration test for direct call resolution in `packages/language/src/__tests__/lsp-navigation.spec.ts`
  - Parse document: `action fadeIn() [...] \nat 0s..1s fadeIn()`
  - Assert `operationCall.operationName.ref === actionDefinition`
  - Assert `operationCall.operationName.ref` has correct source location
  - **Verify tests FAIL (RED phase)**

### Implementation for User Story 1 (GREEN phase)

- [ ] T011 [US1] Extend `EligianScopeProvider.getScope()` in `packages/language/src/eligian-scope-provider.ts`
  - Import `isOperationCall` type guard
  - Import `AstUtils`, `EMPTY_SCOPE` from Langium
  - Import `EligianModel` from generated AST
  - Override `getScope(context: ReferenceInfo): Scope`
  - Check `isOperationCall(context.container) && context.property === 'operationName'`
  - Get document: `const document = AstUtils.getDocument(context.container)`
  - Get model: `const model = document.parseResult.value as EligianModel`
  - Get precomputed scopes: `const precomputedScopes = await this.scopeComputation.computeLocalScopes(document)`
  - Get descriptions at model level: `const descriptions = precomputedScopes.get(model)`
  - Filter for ActionDefinition types: `descriptions.filter(desc => desc.type === 'ActionDefinition')`
  - Return `this.createScope(actionDescriptions)` if found, else `EMPTY_SCOPE`
  - For all other cases: Return `super.getScope(context)`
  - Add JSDoc comments explaining indexed lookup, future library import support

- [ ] T012 [US1] Verify unit tests pass (GREEN phase)
  - Run `npm run test -- references.spec.ts`
  - All US1 unit tests should now pass
  - If not, debug and fix implementation

- [ ] T013 [US1] Verify integration tests pass (GREEN phase)
  - Run `npm run test -- lsp-navigation.spec.ts`
  - US1 integration test should pass
  - Verify `operationCall.operationName.ref` is defined and points to correct ActionDefinition

- [ ] T014 [US1] Manual verification using VS Code extension
  - Create test file: `examples/action-ref-direct-call.eligian`
  - Add action definition and direct timeline call
  - Rebuild extension: `npm run build`
  - Open file in VS Code, Ctrl+Click on action call
  - Verify navigation works

**Checkpoint**: User Story 1 complete - Direct timeline calls navigate to definitions ‚úÖ

---

## Note: Remaining Phases Unchanged

**Phases 4-11 (User Stories 2-5, Recursive Actions, Edge Cases, Performance, Polish)** follow the exact same structure as defined in the full tasks.md document.

The only changes from the original approach are:
1. **Phase 2**: Added ScopeComputation (T004-T008) instead of action-resolver helper
2. **Phase 3**: ScopeProvider now uses precomputed scopes instead of linear search
3. **All other phases**: No code changes, tests remain identical (they test behavior, not implementation)

For the complete task list with all 53 tasks, see the detailed tasks.md sections above.

---

## Summary

**Total Tasks**: 53 (was 50, added 3 for ScopeComputation)

**Key Architecture Change**:
- **Old**: Linear search O(n) through actions
- **New**: Indexed lookup O(1) via ScopeComputation
- **Benefit**: Scales to library imports (100+ actions) with constant-time lookup
- **Future**: Easy extension for cross-file imports (just extend `computeLocalScopes()`)

**Suggested MVP**: User Story 1 only (T001-T014) - Indexed lookup + core navigation
