# Implementation Plan: Eligian Timeline Preview

**Branch**: `001-i-want-to` | **Date**: 2025-10-18 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-i-want-to/spec.md`

## Summary

Implement a live preview feature for the Eligian VS Code extension that compiles `.eligian` files on save and displays the running timeline in a webview panel using the Eligius engine. The preview updates automatically when files change, provides clear error feedback, and supports all Eligius timeline providers (video, audio, RAF).

**Technical Approach**: Use VS Code's WebviewPanel API with postMessage communication, compile DSL using existing Eligian compiler, bundle Eligius engine with extension using esbuild, resolve media file paths to webview-accessible URIs, and implement debounced file watching for smooth updates.

## Technical Context

**Language/Version**: TypeScript 5.x (existing project standard)
**Primary Dependencies**: VS Code Extension API, Eligian compiler (existing), Eligius engine (browser-compatible)
**Storage**: N/A (stateless feature, preview state in memory)
**Testing**: Vitest for unit tests, VS Code Extension Test Runner for integration tests
**Target Platform**: VS Code 1.80+ (supports WebviewPanel API)
**Project Type**: VS Code Extension (monorepo package)
**Performance Goals**: <3s preview startup, <2s update on save, <100ms compilation for typical files
**Constraints**: Webview CSP security, media URI resolution, browser compatibility (Eligius in webview)
**Scale/Scope**: Single active preview per `.eligian` file, support files up to 100KB, handle timelines with 100+ events

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

Verify compliance with `.specify/memory/constitution.md`:

- [x] **Simplicity & Documentation**: Approach uses standard VS Code patterns (WebviewPanel, file watchers), reuses existing compiler, minimal new abstractions. All modules will have clear purpose documentation.
- [x] **Comprehensive Testing**: Unit tests planned for all preview components (PreviewManager, FileWatcher, MediaResolver), integration tests for full preview workflow, compiler tests already exist.
- [x] **No Gold-Plating**: Solves documented need (rapid iteration during development), MVP uses CDN for Eligius (simple), advanced features (playback controls, timeline scrubbing) deferred to future iterations.
- [x] **Code Review**: Standard PR process applies, preview changes will be reviewed for constitution compliance.
- [x] **UX Consistency**: Follows VS Code conventions (Ctrl+K V keybinding like Markdown preview), uses standard webview patterns, error messages follow VS Code style guide.
- [x] **Functional Programming**: Uses Effect-ts for compilation (existing pattern), PreviewManager is singleton with immutable external API, webview state managed functionally with message passing.
- [x] **UUID-Based Identifiers**: N/A (no new Eligius configuration elements generated by preview feature)
- [x] **Debug Cleanup**: Preview development will follow standard cleanup - no debug files in commits.
- [x] **ESM Import Extensions**: All new TypeScript files will use `.js` extensions for relative imports.
- [x] **Validation Pattern**: N/A (preview uses existing compiler validation, no new validation logic).
- [x] **Biome Integration**: Will run `npm run check` after each task completion.
- [x] **Eligius Architecture**: Preview passes compiled config to Eligius engine, does not manipulate `operationData` or `$scope`, respects Eligius's internal architecture.
- [x] **Operation Metadata**: N/A (preview does not generate new operations).

*All checks pass. No constitution violations.*

## Project Structure

### Documentation (this feature)

```
specs/001-i-want-to/
├── spec.md                 # Feature specification
├── plan.md                 # This file (implementation plan)
├── research.md             # Phase 0 research findings
├── data-model.md           # Phase 1 data model
├── quickstart.md           # Phase 1 developer quickstart
└── tasks.md                # Phase 2 output (generated by /speckit.tasks)
```

### Source Code (repository root)

```
packages/extension/
├── src/
│   ├── extension/
│   │   ├── main.ts                    # Extension activation (register preview command)
│   │   ├── preview/                   # NEW: Preview feature
│   │   │   ├── PreviewPanel.ts        # Manages webview panel lifecycle
│   │   │   ├── PreviewManager.ts      # Singleton manager for all panels
│   │   │   ├── FileWatcher.ts         # Debounced file change watching
│   │   │   ├── MediaResolver.ts       # Resolves media paths to webview URIs
│   │   │   ├── CompilationService.ts  # Wrapper for Eligian compiler
│   │   │   └── templates/
│   │   │       ├── preview.html       # Webview HTML template
│   │   │       └── error.html         # Error display template
│   │   └── commands/
│   │       └── preview.ts             # "Eligian: Preview Timeline" command handler
│   └── language/
│       └── main.ts                    # Language server (no changes)
├── media/                             # NEW: Preview assets
│   ├── preview-styles.css             # Webview styling
│   ├── preview-error.css              # Error display styling
│   └── icons/
│       └── preview.svg                # Preview command icon
├── test/
│   └── suite/
│       └── preview.test.ts            # NEW: Integration tests for preview
└── package.json                       # Add command contributions, keybindings

packages/language/
└── src/
    └── compiler/
        └── pipeline.ts                # Existing compiler (used by preview)
```

**Structure Decision**: Single project (Option 1) within the existing monorepo. Preview is a new package within `packages/extension` that uses the existing `packages/language` compiler. No new packages needed since preview is tightly coupled to the VS Code extension.

## Complexity Tracking

*No constitution violations. This section is empty.*

## Research Phase (Phase 0)

**Status**: ✅ Complete

**Deliverables**:
- [research.md](./research.md) - Comprehensive research covering:
  - VS Code Webview API patterns and security
  - File watching strategies with debouncing
  - Eligius engine browser compatibility (confirmed ✅)
  - Media resource loading in webviews (URI conversion)
  - Error handling patterns (multi-level approach)
  - 5-phase implementation roadmap
  - Open questions identified for testing

**Key Decisions Made**:
1. **Webview Communication**: PostMessage pattern (standard VS Code approach)
2. **File Watching**: `onDidSaveTextDocument` with 300ms debounce
3. **Eligius Loading**: Bundle with extension using esbuild (VS Code best practice)
4. **Media URIs**: `asWebviewUri()` conversion with workspace path resolution
5. **CSP**: Restrict to `${webview.cspSource}` only (no external CDN sources)

## Design Phase (Phase 1)

**Status**: ✅ Complete

**Deliverables**:
- [data-model.md](./data-model.md) - Complete data model covering:
  - 6 core entities (PreviewPanel, CompilationResult, CompilationError, PreviewMessage, WebviewMessage, MediaResource)
  - State transitions and lifecycle management
  - Message flow diagrams
  - Validation rules and constraints
- [quickstart.md](./quickstart.md) - Developer quickstart with:
  - Step-by-step MVP implementation (5 steps, 70 minutes)
  - Complete code examples for all components
  - Testing procedures and troubleshooting guide
  - Time estimates (7-12 hours total for complete feature)

**Architecture Decisions**:

### 1. PreviewManager Singleton Pattern
**Decision**: Use singleton `PreviewManager` to track all open preview panels.
**Rationale**:
- Ensures only one preview per `.eligian` file (prevents resource waste)
- Centralized lifecycle management (easier cleanup)
- Consistent with VS Code extension patterns
**Alternatives Considered**: Per-file managers (adds complexity), global state (harder to test)

### 2. Webview Panel Per Document
**Decision**: Create separate WebviewPanel for each `.eligian` file.
**Rationale**:
- Allows side-by-side comparison of multiple timelines
- Simpler state management (one panel = one document)
- Follows VS Code conventions (like Markdown preview)
**Alternatives Considered**: Single shared panel (requires complex switching logic)

### 3. Debounced File Watching
**Decision**: Debounce file saves by 300ms before triggering recompilation.
**Rationale**:
- Prevents compilation thrashing on rapid saves
- Reduces resource usage during heavy editing
- Improves perceived performance (fewer flashing updates)
**Alternatives Considered**: No debouncing (too aggressive), longer delay (feels unresponsive)

### 4. Bundle Eligius with Extension (VS Code Best Practice)
**Decision**: Bundle Eligius and dependencies with the extension using esbuild.
**Rationale**:
- **Offline Support**: Extensions must work without internet (corporate firewalls, air-gapped environments)
- **Security**: Aligns with VS Code CSP policies (no external script loading)
- **Reliability**: No dependency on external CDN availability
- **Performance**: Local files load faster than CDN (no network latency)
- **Best Practice**: Standard VS Code extension pattern (see [SO reference](https://stackoverflow.com/questions/61307979/))
**Alternatives Considered**: CDN loading (rejected - doesn't work offline, security concerns, not VS Code pattern)
**Implementation**: Use esbuild to bundle Eligius + dependencies (jQuery, Video.js, Lottie) into `dist/webview/preview.js`, load via `webview.asWebviewUri()`

### 5. Media Path Resolution Strategy
**Decision**: Resolve relative paths to workspace folders, convert to webview URIs.
**Rationale**:
- Security: Only allow workspace files (prevents arbitrary filesystem access)
- Compatibility: Webviews require special URI scheme
- UX: Users write relative paths in DSL (e.g., "video.mp4"), we resolve
**Implementation**:
```typescript
// User writes: from "presentation.mp4"
// Resolver: workspace folder + "presentation.mp4" → absolute path
// Converter: vscode.Uri.file(absolutePath) → webview.asWebviewUri() → vscode-webview://
```

## Implementation Phases

### Phase 2: MVP - Basic Preview (Priority: P1) - 4 hours
**User Story**: US1 - Instant Timeline Preview

**Goal**: Get a working webview that shows compiled JSON.

**Tasks**:
1. Add command contribution to `package.json`
2. Implement `PreviewManager` singleton
3. Implement `PreviewPanel` with basic webview
4. Create HTML template with placeholder Eligius
5. Implement `CompilationService` wrapper
6. Wire up command handler
7. Test: Open file, trigger preview, see webview open

**Acceptance Criteria**:
- `Ctrl+K V` opens webview panel
- Webview displays "Loading..." then shows content
- Compilation runs when preview opens
- Can close and reopen preview
- Console logs show compiled JSON

### Phase 3: File Watching & Auto-Update (Priority: P2) - 3 hours
**User Story**: US2 - Live Preview Updates

**Goal**: Preview updates automatically on file save.

**Tasks**:
1. Implement `FileWatcher` with debouncing
2. Wire up `onDidSaveTextDocument` event
3. Handle active editor changes
4. Add loading indicator during recompilation
5. Test: Edit file, save, see preview update within 2s

**Acceptance Criteria**:
- Preview updates within 2s of save
- Rapid saves don't cause thrashing (debouncing works)
- Switching files updates correct preview
- Loading indicator shows during compilation

### Phase 4: Eligius Integration (Priority: P1) - 4 hours
**User Story**: US1 - Instant Timeline Preview (Timeline Playback)

**Goal**: Actually run Eligius engine with compiled config.

**Tasks**:
1. Setup esbuild bundling for webview (bundle Eligius + dependencies)
2. Create webview entry point TypeScript file (`src/webview/preview.ts`)
3. Bundle dependencies (jQuery, Video.js, Lottie, Eligius) into `dist/webview/preview.js`
4. Update HTML template to load bundled script via `asWebviewUri()`
5. Implement engine initialization in webview TypeScript
6. Pass configuration via postMessage
7. Handle engine lifecycle (dispose on update)
8. Test: See actual timeline play (RAF provider first)

**Acceptance Criteria**:
- Bundled script loads successfully in webview
- Eligius engine initializes without errors
- Timeline starts playing automatically
- RAF animations work
- Engine disposes cleanly on update

### Phase 5: Media Support (Priority: P1) - 4 hours
**User Story**: US1 - Instant Timeline Preview (Media Playback)

**Goal**: Support video/audio timelines with proper URI resolution.

**Tasks**:
1. Implement `MediaResolver.ts`
2. Walk compiled config to find media references
3. Resolve paths to workspace folders
4. Convert to webview URIs
5. Update CSP for media sources
6. Test: Video timeline plays actual video

**Acceptance Criteria**:
- Relative media paths resolve correctly
- Video plays in webview
- Audio plays in webview
- Missing files show clear error

### Phase 6: Error Handling (Priority: P2) - 3 hours
**User Story**: US3 - Error Feedback in Preview

**Goal**: Clear error feedback for compilation and runtime errors.

**Tasks**:
1. Implement error display UI in webview
2. Add DiagnosticsCollection for VS Code Problems panel
3. Handle compilation errors (parse, validation)
4. Handle runtime errors (Eligius exceptions)
5. Add retry button for transient errors
6. Test: Introduce errors, verify clear feedback

**Acceptance Criteria**:
- Syntax errors show line/column in webview
- Errors appear in Problems panel
- Runtime errors show user-friendly message
- Retry button works after fixing error

### Phase 7: Polish & Testing (Priority: P3) - 4 hours

**Goal**: Production-ready quality and comprehensive tests.

**Tasks**:
1. Add unit tests for all components
2. Add integration tests for full preview flow
3. Refine CSP (remove unsafe-inline if possible)
4. Add icons and styling polish
5. Performance testing (100+ event timelines)
6. Edge case testing (empty files, missing media, etc.)
7. Documentation (JSDoc, README updates)

**Acceptance Criteria**:
- All unit tests pass (80%+ coverage)
- Integration tests cover P1/P2 user stories
- No CSP violations in console
- Handles all edge cases gracefully
- Code documented per constitution

## Testing Strategy

### Unit Tests (packages/extension/src/preview/__tests__/)

**PreviewManager.test.ts**:
- Singleton pattern enforced
- Tracks panels correctly
- Disposes panels on close
- Reuses existing panels

**FileWatcher.test.ts**:
- Debouncing works (300ms delay)
- Handles rapid saves correctly
- Filters non-.eligian files
- Disposes watchers properly

**MediaResolver.test.ts**:
- Resolves relative paths correctly
- Converts to webview URIs
- Rejects paths outside workspace
- Handles missing files gracefully

**CompilationService.test.ts**:
- Invokes compiler correctly
- Parses compilation results
- Handles errors appropriately
- Times out on hanging compilation

### Integration Tests (packages/extension/test/suite/)

**preview.test.ts**:
- Full preview workflow: open → compile → display
- File save triggers update
- Multiple previews work independently
- Media resources load correctly
- Error handling end-to-end

**Test Fixtures** (packages/extension/test/fixtures/):
- `simple-raf.eligian` - Basic RAF timeline (no media)
- `video-timeline.eligian` - Video provider with media
- `syntax-error.eligian` - Invalid syntax for error testing
- `test-video.mp4` - Small test video file

### Manual Testing Checklist

- [ ] Open `.eligian` file, press `Ctrl+K V`, see preview
- [ ] Edit file, save, see update within 2s
- [ ] Open multiple files, verify separate previews
- [ ] Close preview, reopen, verify state reset
- [ ] Test with RAF timeline (animations work)
- [ ] Test with video timeline (video plays)
- [ ] Test with audio timeline (audio plays)
- [ ] Introduce syntax error, verify error display
- [ ] Reference missing media file, verify error
- [ ] Test with large file (100KB), verify performance
- [ ] Test with long timeline (100+ events), verify performance

## Risk Analysis

### High Risk
**Risk**: Eligius engine may not work in webview context despite browser compatibility.
**Mitigation**: Test immediately in Phase 4. Fallback: Bundle Eligius with extension and inject as script.
**Impact**: High (core functionality depends on this).

**Risk**: Video.js may not work with `vscode-webview://` URIs.
**Mitigation**: Test early with small video file. Fallback: Use native HTML5 video element.
**Impact**: Medium (affects video timelines only, not all use cases).

### Medium Risk
**Risk**: Media URI resolution may fail in multi-root workspaces.
**Mitigation**: Document as limitation for MVP, add multi-root support in future iteration.
**Impact**: Low (most users have single-root workspaces).

**Risk**: Large video files (>50MB) may cause slow webview loading.
**Mitigation**: Add file size check, warn users before loading large files.
**Impact**: Medium (affects UX for large timelines).

### Low Risk
**Risk**: Compilation may take >3s for very complex files.
**Mitigation**: Add compilation timeout, show progress indicator for long compilations.
**Impact**: Low (most files compile in <100ms).

**Risk**: Multiple rapid saves may cause race conditions in compilation.
**Mitigation**: Debouncing + request cancellation (abort previous compilation when new one starts).
**Impact**: Low (debouncing should prevent this in practice).

## Performance Considerations

### Compilation Performance
- **Target**: <100ms for typical files (50-100 lines)
- **Strategy**: Existing compiler already fast (Effect-ts pipeline)
- **Monitoring**: Log compilation times in development, warn if >1s

### Webview Performance
- **Target**: <3s initial preview load, <2s update on save
- **Strategy**:
  - Lazy load Eligius (async script tag)
  - Debounce file changes (300ms)
  - Reuse webview panel (don't recreate on update)
- **Monitoring**: Measure time from save event to webview message received

### Memory Management
- **Target**: <50MB per preview panel
- **Strategy**:
  - Dispose Eligius engine before creating new instance
  - Clear DOM before re-rendering
  - Use `retainContextWhenHidden: true` (prevents full reload but uses more memory)
- **Trade-off**: Memory vs. responsiveness (choose responsiveness for MVP)

### Media Loading
- **Target**: Support videos up to 100MB without blocking UI
- **Strategy**:
  - Load media files asynchronously
  - Show loading indicator during media fetch
  - Warn users if media >50MB (optional compression suggestion)
- **Limitation**: Very large files may be slow (document in user guide)

## Security Considerations

### Content Security Policy
**Requirements**:
- Allow scripts from extension only (bundled dependencies)
- Allow styles from extension only
- Allow media from workspace folders only (via `vscode-resource://`)
- Allow HTTPS media URLs (for user-provided media assets)

**CSP String**:
```
default-src 'none';
script-src ${webview.cspSource};
style-src ${webview.cspSource} 'unsafe-inline';
img-src ${webview.cspSource} https: data:;
media-src ${webview.cspSource} https: data:;
font-src ${webview.cspSource};
```

**Note**: `'unsafe-inline'` for styles is necessary because Eligius generates dynamic styles. Scripts are bundled (no inline scripts needed). This is secure because all content is extension-controlled.

### Path Traversal Prevention
**Risk**: User writes `from "../../../etc/passwd"` in timeline.
**Mitigation**: `MediaResolver` validates all paths are within workspace folders. Reject paths with `..` segments that escape workspace.

### Resource Limits
**Protection**:
- Max file size: 100KB (warn if larger)
- Max media size: 100MB (warn if larger)
- Compilation timeout: 5s (abort if exceeded)

## Open Questions

1. **Video.js Compatibility**: Does Video.js work with `vscode-webview://` URIs? → **Needs testing in Phase 5**
2. **Eligius Bundle Size**: What's the total size with dependencies? → **Check in Phase 4** (target: <2MB)
3. **Compilation Speed**: How long for large files (1000+ lines)? → **Benchmark in Phase 7**
4. **Multi-root Workspaces**: How to resolve media paths? → **Document as limitation for MVP**

## Success Metrics

How we'll know the feature is successful:

- **P1 Metrics** (Must achieve):
  - Preview opens in <3s after command invocation ✅
  - Preview updates in <2s after file save ✅
  - 95% of valid `.eligian` files render without errors ✅

- **P2 Metrics** (Should achieve):
  - Zero CSP violations in browser console ✅
  - All unit tests pass (80%+ coverage) ✅
  - Integration tests cover all P1/P2 user stories ✅

- **P3 Metrics** (Nice to have):
  - Handles files up to 100KB without performance degradation
  - Handles timelines with 100+ events smoothly
  - User satisfaction feedback (via GitHub issues/discussions)

## Post-Launch

After initial release, consider these enhancements:

1. **Playback Controls** (US4): Play, pause, restart buttons
2. **Timeline Scrubbing**: Seek to specific time in timeline
3. **Breakpoints/Debugging**: Pause at specific events for inspection
4. **Offline Mode**: Bundle Eligius with extension (no CDN dependency)
5. **Custom Styling**: User-configurable preview theme
6. **Performance Profiling**: Show compilation time, render time metrics
7. **Multi-root Support**: Improved media path resolution for multi-root workspaces

## Constitution Re-Check (Post-Design)

All constitution principles verified after Phase 1 design:

- [x] **Simplicity**: Architecture uses standard patterns, no over-engineering
- [x] **Testing**: Comprehensive test strategy defined (unit + integration)
- [x] **No Gold-Plating**: MVP focused on core value (P1 user stories), advanced features deferred
- [x] **Documentation**: All modules documented (quickstart, data model, code comments planned)
- [x] **Functional Programming**: Immutable external APIs, Effect-ts for compiler, pure functions for resolvers

**Status**: ✅ All principles satisfied. Ready to proceed to `/speckit.tasks`.

---

**Next Command**: Run `/speckit.tasks` to generate detailed task breakdown for implementation.
