# Implementation Plan: Error Type Unification

**Branch**: `018-error-type-unification` | **Date**: 2025-01-28 | **Spec**: [spec.md](./spec.md)

## Summary

Consolidate 5 duplicate error type hierarchies across packages into a single unified error namespace in `@eligian/language/src/errors/`. Eliminates 200-300 lines of duplicate code, ensures consistent error messages across all tools, and provides type-safe error handling.

**Technical Approach**: Create unified error namespace with discriminated unions, type guards, and formatting utilities. Leverage patterns from Phase 1 (shared-utils) and Phase 2 (CSS consolidation) for gradual, backward-compatible migration.

## Technical Context

**Language/Version**: TypeScript 5.6+ with NodeNext module resolution (ESM)
**Primary Dependencies**: Effect-ts, Langium, PostCSS, vscode APIs
**Storage**: N/A (in-memory data structures)
**Testing**: Vitest with 80% coverage threshold
**Target Platform**: Node.js 20+ (Windows, Linux, macOS)
**Project Type**: Monorepo with 4 packages (language, extension, cli, shared-utils)
**Performance Goals**: Error formatting <10ms, type guards <1ms
**Constraints**: Zero breaking changes, backward compatibility during migration
**Scale/Scope**: 5 error hierarchies, 4 packages, ~200-300 lines duplicate code

## Constitution Check

- [x] **Simplicity & Documentation**: Clear error hierarchy, no complex inheritance
- [x] **Comprehensive Testing**: Unit + integration tests for all error types
- [x] **No Gold-Plating**: Solves real problem (5 duplicate hierarchies)
- [x] **Code Review**: Standard PR process
- [x] **UX Consistency**: Error messages remain consistent
- [x] **Functional Programming**: Discriminated unions, pure type guards

**Result**: ✅ ALL CHECKS PASS

## Project Structure

### Documentation

```
specs/018-error-type-unification/
├── plan.md           # This file
├── research.md       # Analysis of 5 existing hierarchies
├── data-model.md     # Unified error type design
├── quickstart.md     # Error handling guide
├── contracts/
│   ├── error-types.ts
│   └── type-guards.ts
└── tasks.md          # Generated by /speckit.tasks
```

### Source Code

```
packages/language/src/
├── errors/                              # NEW: Unified namespace
│   ├── index.ts                         # Barrel exports
│   ├── base.ts                          # BaseError + SourceLocation
│   ├── compiler-errors.ts               # CompilerError union
│   ├── io-errors.ts                     # Re-export from shared-utils
│   ├── asset-errors.ts                  # AssetError union
│   ├── type-guards.ts                   # Type guards
│   ├── formatters.ts                    # Error formatting
│   └── __tests__/
│       ├── type-guards.spec.ts
│       ├── formatters.spec.ts
│       └── error-consistency.spec.ts
├── compiler/types/errors.ts             # MIGRATE
├── asset-loading/types.ts               # MIGRATE
├── validators/validation-errors.ts      # MIGRATE
└── css/css-parser.ts                    # MIGRATE
```

## Existing Error Hierarchies (5 Sources)

### 1. Compiler Errors (`compiler/types/errors.ts`)
- **Types**: CompileError, ParseError, ValidationError, TypeError, TransformError, OptimizationError, EmitError
- **Pattern**: Discriminated unions with `_tag` field ✅
- **Status**: Well-structured, will serve as pattern template

### 2. Asset Loading Errors (`asset-loading/types.ts`)
- **Types**: AssetError, HtmlValidationError, CssValidationError, MediaValidationError, SourceLocation
- **Pattern**: Interfaces (not discriminated unions)
- **Issue**: Inconsistent with compiler errors, duplicate SourceLocation

### 3. Import Validation Errors (`validators/validation-errors.ts`)
- **Types**: ImportValidationError, PathError, ImportNameError, TypeInferenceError, DuplicateDefaultImportError
- **Pattern**: Interfaces with `code` field (not `_tag`)
- **Issue**: Includes ERROR_MESSAGES template object (good pattern to preserve)

### 4. Extension CSS Loader Errors (`extension/css-loader.ts`)
- **Types**: FileNotFoundError, PermissionError, ReadError (class definitions)
- **Status**: **DEPRECATED** in Phase 2 - now uses `@eligian/shared-utils` errors ✅

### 5. Extension Compilation Errors (`extension/preview/CompilationService.ts`)
- **Types**: CompilationError, CompilationResult
- **Pattern**: Simplified interface for VS Code diagnostics
- **Issue**: Loses compiler error context

### 6. CSS Parse Errors (`css/css-parser.ts`)
- **Types**: CSSParseError, CSSSourceLocation
- **Pattern**: Interface, embedded in CSSParseResult
- **Issue**: Duplicate location type

### 7. Shared Utils IOError (`shared-utils/src/errors.ts` - Phase 1)
- **Types**: FileOperationError, FileNotFoundError, PermissionError, ReadError, SecurityError
- **Status**: ✅ Already unified! Discriminated unions with type guards

## Consolidation Strategy

### Overlap Analysis

**SourceLocation** (3 duplicates):
- Decision: Use compiler's SourceLocation as canonical

**File I/O Errors**:
- Decision: Re-export from `@eligian/shared-utils` (Phase 1 complete)

**Asset Validation Errors**:
- Decision: Merge into unified AssetError union

**Generic Fields**:
- Decision: Standardize on `_tag` (TypeScript best practice)

### Unified Hierarchy Design

```typescript
@eligian/language/errors
├── BaseError (common fields: message, location, hint)
├── CompilerError (union)
│   ├── ParseError
│   ├── ValidationError
│   ├── TypeError
│   ├── TransformError
│   ├── OptimizationError
│   └── EmitError
├── IOError (re-exported from @eligian/shared-utils)
│   ├── FileNotFoundError
│   ├── PermissionError
│   ├── ReadError
│   └── SecurityError
├── AssetError (union)
│   ├── HtmlValidationError
│   ├── CssValidationError
│   ├── CssParseError
│   └── MediaValidationError
└── AllErrors (union of all types)
```

### Type Guard Pattern

```typescript
function isParseError(error: unknown): error is ParseError
function isCompilerError(error: unknown): error is CompilerError
function isIOError(error: unknown): error is IOError
function isAssetError(error: unknown): error is AssetError
```

### Error Formatter Pattern

```typescript
function formatError(error: AllErrors): string
function formatErrorWithSnippet(error: AllErrors, source: string): string
function formatForVSCode(error: AllErrors): vscode.Diagnostic
```

## Migration Strategy

**Gradual, Backward-Compatible Migration**:

**Phase 1**: Create unified namespace
- Create `packages/language/src/errors/` with all types
- Export from `@eligian/language/index.ts`
- No breaking changes (existing code continues to work)

**Phase 2**: Add adapter re-exports
- Old locations re-export from new namespace
- Add `@deprecated` JSDoc warnings
- Gradual migration guidance

**Phase 3**: Migrate packages (separate PRs)
- Update imports to `@eligian/language/errors`
- Verify tests pass
- One package at a time

**Phase 4**: Remove deprecated definitions
- Delete old files
- Remove re-export adapters
- Update documentation

## Key Design Decisions

**1. BaseError Type**:
```typescript
interface BaseError {
  readonly message: string;
  readonly location?: SourceLocation;
  readonly hint?: string;
}
```

**2. Discriminated Unions**:
```typescript
type ParseError = BaseError & {
  readonly _tag: 'ParseError';
  readonly expected?: string;
  readonly actual?: string;
};
```

**3. IOError Re-Export**:
- Phase 1 already unified IOError in `@eligian/shared-utils`
- Language package re-exports for convenience
- Single import location for consumers

**4. Effect-ts Integration**:
- Compiler errors work with Effect.fail() unchanged
- No changes to compilation pipeline

**5. VS Code Diagnostic Mapping**:
- Unified formatters provide standard mapping
- Extension uses formatters instead of custom code

## Performance Characteristics

**Zero Runtime Overhead**:
- Plain objects (no classes, no prototype chain)
- Type guards: simple property checks (<1μs)
- Formatting only on display (not hot path)

**Expected Performance**:
- Type guard: <1μs
- Error construction: <10μs
- Formatting: <10ms

**Memory**:
- Error objects: ~100-500 bytes
- Code size reduction: 200-300 lines (better cache locality)

## Success Metrics

- **SC-001**: 100% error message consistency (integration tests)
- **SC-002**: 200-300 lines eliminated (git diff)
- **SC-003**: 100% type safety (no `any`)
- **SC-004**: New error types in <10 minutes
- **SC-005**: Zero test regressions (1067 tests pass)
- **SC-006**: 5+ locations → 1 location

## Risk Mitigation

| Risk | Mitigation |
|------|------------|
| Breaking error handling | Gradual migration, adapter re-exports |
| Inconsistent messages | Integration tests verify consistency |
| Missed error types | Grep audit, migration checklist |
| LSP serialization | Plain objects naturally JSON-serializable |

## Dependencies

- ✅ Phase 1 (Shared Utilities): IOError types, discriminated union pattern
- ✅ Phase 2 (CSS Consolidation): Migration pattern, CSS error types

**No New Dependencies**: Uses only TypeScript + Node.js built-ins

## Next Steps

Phase 0 outputs (generated by this `/speckit.plan` command):
1. ✅ `research.md` - Detailed analysis of 5 error hierarchies
2. ✅ `data-model.md` - Unified error type specifications
3. ✅ `quickstart.md` - Error handling usage guide
4. ✅ `contracts/` - TypeScript type contracts

Phase 2: Run `/speckit.tasks` to generate implementation tasks
